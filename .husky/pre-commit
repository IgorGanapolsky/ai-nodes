#!/usr/bin/env sh
. "$(dirname "$0")/_/h"

echo "ğŸš€ Running pre-commit validation..."

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "âŒ Not in a git repository"
  exit 1
fi

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only)

if [ -z "$STAGED_FILES" ]; then
  echo "âš ï¸  No staged files found"
  exit 0
fi

echo "ğŸ“ Found staged files:"
echo "$STAGED_FILES" | sed 's/^/  - /'

# Run trunk check on staged files if trunk is available
if command -v trunk >/dev/null 2>&1; then
  echo "ğŸ” Running Trunk checks..."
  if ! trunk check --upstream; then
    echo "âŒ Trunk checks failed"
    exit 1
  fi
  echo "âœ… Trunk checks passed"
else
  echo "âš ï¸  Trunk CLI not found, skipping trunk checks"
fi

# Run lint-staged for comprehensive linting and formatting
echo "ğŸ”§ Running lint-staged checks..."
if ! pnpm -w exec lint-staged; then
  echo "âŒ lint-staged checks failed"
  echo "ğŸ’¡ Try running 'pnpm lint' and 'pnpm format' to fix issues"
  exit 1
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸ‰ Ready to commit!"

