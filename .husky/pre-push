#!/usr/bin/env sh
. "$(dirname "$0")/_/h"

echo "🚀 Running pre-push validation..."

# Check if we're pushing to protected branches
PROTECTED_BRANCHES="main master"
CURRENT_BRANCH=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

for branch in $PROTECTED_BRANCHES; do
  if [ "$CURRENT_BRANCH" = "$branch" ]; then
    echo "⚠️  Pushing to protected branch: $branch"
    echo "🔍 Running comprehensive checks..."

    # Run type checking
    echo "📋 Running TypeScript type checking..."
    if ! pnpm type-check; then
      echo "❌ Type checking failed"
      exit 1
    fi

    # Run tests
    echo "🧪 Running tests..."
    if ! pnpm test; then
      echo "❌ Tests failed"
      exit 1
    fi

    # Run linting
    echo "🔧 Running linting..."
    if ! pnpm lint; then
      echo "❌ Linting failed"
      exit 1
    fi

    # Run build to ensure everything compiles
    echo "🏗️  Running build..."
    if ! pnpm build; then
      echo "❌ Build failed"
      exit 1
    fi

    break
  fi
done

# Run trunk check if available
if command -v trunk >/dev/null 2>&1; then
  echo "🔍 Running final Trunk security and quality checks..."
  if ! trunk check --all; then
    echo "❌ Trunk checks failed"
    echo "💡 Run 'trunk check --all --fix' to auto-fix issues"
    exit 1
  fi
fi

echo "✅ All pre-push checks passed!"
echo "🎉 Safe to push!"