#!/usr/bin/env sh
. "$(dirname "$0")/_/h"

echo "ğŸš€ Running pre-push validation..."

# Check if we're pushing to protected branches
PROTECTED_BRANCHES="main master"
CURRENT_BRANCH=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

for branch in $PROTECTED_BRANCHES; do
  if [ "$CURRENT_BRANCH" = "$branch" ]; then
    echo "âš ï¸  Pushing to protected branch: $branch"
    echo "ğŸ” Running comprehensive checks..."

    # Run type checking
    echo "ğŸ“‹ Running TypeScript type checking..."
    if ! pnpm type-check; then
      echo "âŒ Type checking failed"
      exit 1
    fi

    # Run tests
    echo "ğŸ§ª Running tests..."
    if ! pnpm test; then
      echo "âŒ Tests failed"
      exit 1
    fi

    # Run linting
    echo "ğŸ”§ Running linting..."
    if ! pnpm lint; then
      echo "âŒ Linting failed"
      exit 1
    fi

    # Run build to ensure everything compiles
    echo "ğŸ—ï¸  Running build..."
    if ! pnpm build; then
      echo "âŒ Build failed"
      exit 1
    fi

    break
  fi
done

# Run trunk check if available
if command -v trunk >/dev/null 2>&1; then
  echo "ğŸ” Running final Trunk security and quality checks..."
  if ! trunk check --all; then
    echo "âŒ Trunk checks failed"
    echo "ğŸ’¡ Run 'trunk check --all --fix' to auto-fix issues"
    exit 1
  fi
fi

echo "âœ… All pre-push checks passed!"
echo "ğŸ‰ Safe to push!"